<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPOP DEMON HUNTER ‚Äî Golden Song Invitation</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;700;900&family=Cinzel+Decorative:wght@400;700;900&family=Noto+Sans+KR:wght@100;300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #FFD700;
    --gold2: #FFA500;
    --crimson: #8B0000;
    --blood: #C0392B;
    --dark: #050505;
    --darkpurple: #0D0010;
    --ink: #1a0020;
    --silver: #C0C0C0;
    --ghostwhite: #F8F0FF;
    --teal: #00FFCC;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--dark);
    font-family: 'Noto Sans KR', sans-serif;
    overflow-x: hidden;
    cursor: crosshair;
  }

  /* ===== PARTICLE CANVAS ===== */
  #particleCanvas {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events: none;
    z-index: 0;
  }

  /* ===== SCENE LAYERS ===== */
  .scene {
    position: relative;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1;
  }

  /* ===== INTRO SCREEN ===== */
  #intro {
    background: radial-gradient(ellipse at 50% 30%, #1a0030 0%, #050005 60%, #000 100%);
    overflow: hidden;
  }

  .blood-moon {
    position: absolute;
    top: 8vh;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: radial-gradient(circle at 40% 40%, #ff6b35, #cc0000 50%, #660000);
    box-shadow:
      0 0 60px 20px rgba(200,0,0,0.4),
      0 0 120px 40px rgba(150,0,0,0.2),
      inset 0 0 40px rgba(0,0,0,0.5);
    animation: moonPulse 4s ease-in-out infinite;
  }
  .blood-moon::before {
    content:'';
    position:absolute; inset:0;
    border-radius:50%;
    background: radial-gradient(circle at 60% 35%, rgba(255,160,80,0.3), transparent 50%);
  }

  @keyframes moonPulse {
    0%,100% { box-shadow: 0 0 60px 20px rgba(200,0,0,0.4), 0 0 120px 40px rgba(150,0,0,0.2); }
    50% { box-shadow: 0 0 80px 30px rgba(255,50,0,0.6), 0 0 160px 60px rgba(200,0,0,0.3); }
  }

  .mount-silhouette {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 40vh;
  }

  /* SVG mountains */
  .mount-silhouette svg {
    width:100%; height:100%;
  }

  .cherry-blossom {
    position: absolute;
    font-size: 18px;
    animation: fallingPetal linear infinite;
    opacity: 0;
    pointer-events: none;
  }

  @keyframes fallingPetal {
    0% { transform: translateY(-10vh) rotate(0deg) translateX(0); opacity:0; }
    10% { opacity: 0.7; }
    90% { opacity: 0.4; }
    100% { transform: translateY(110vh) rotate(720deg) translateX(80px); opacity:0; }
  }

  .intro-content {
    position: relative;
    text-align: center;
    z-index:5;
    margin-top: 220px;
  }

  .eyebrow {
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 11px;
    letter-spacing: 8px;
    color: var(--gold);
    text-transform: uppercase;
    opacity: 0.7;
    animation: fadeIn 2s ease 0.5s both;
  }

  .main-title {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(36px, 8vw, 90px);
    font-weight: 900;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 30%, #FF6B35 60%, #FFD700 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 0 30px rgba(255,165,0,0.5));
    line-height: 1;
    animation: titleReveal 1.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
    position: relative;
  }

  .main-title::after {
    content: attr(data-text);
    position:absolute;
    left:0; top:0;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 30%, #FF6B35 60%, #FFD700 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: blur(20px);
    opacity: 0.4;
    z-index:-1;
  }

  .korean-sub {
    font-family: 'Noto Serif KR', serif;
    font-size: clamp(14px, 3vw, 22px);
    color: var(--gold);
    letter-spacing: 4px;
    opacity: 0.8;
    margin: 8px 0 20px;
    animation: fadeIn 2s ease 1s both;
  }

  .subtitle {
    font-family: 'Noto Sans KR', sans-serif;
    font-size: clamp(12px, 2vw, 16px);
    color: var(--silver);
    letter-spacing: 3px;
    opacity: 0.5;
    margin-bottom: 50px;
    animation: fadeIn 2s ease 1.3s both;
  }

  @keyframes titleReveal {
    from { opacity:0; transform: translateY(40px) scale(0.9); filter: drop-shadow(0 0 0px transparent) blur(10px); }
    to { opacity:1; transform: translateY(0) scale(1); filter: drop-shadow(0 0 30px rgba(255,165,0,0.5)); }
  }
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(20px); }
    to { opacity:1; transform:translateY(0); }
  }

  /* ===== CHARACTERS ===== */
  .characters-row {
    display: flex;
    gap: 30px;
    justify-content: center;
    align-items: flex-end;
    margin: 20px 0 40px;
    animation: fadeIn 1.5s ease 1.8s both;
  }

  .char-card {
    position: relative;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .char-card:hover { transform: translateY(-15px) scale(1.05); }
  .char-card:hover .char-aura { opacity: 1; }

  .char-figure {
    width: 90px;
    height: 140px;
    position: relative;
  }

  .char-aura {
    position:absolute;
    inset:-10px;
    border-radius: 50% 50% 40% 40%;
    opacity:0;
    transition: opacity 0.3s;
    filter: blur(8px);
  }

  .char-name {
    text-align:center;
    font-family: 'Noto Serif KR', serif;
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 2px;
    margin-top: 8px;
    opacity: 0.7;
  }

  /* Character SVG art styles */
  .hunter-blade .char-aura { background: radial-gradient(circle, rgba(0,200,255,0.6), transparent 70%); }
  .demon-lord .char-aura { background: radial-gradient(circle, rgba(200,0,50,0.6), transparent 70%); }
  .golden-singer .char-aura { background: radial-gradient(circle, rgba(255,200,0,0.6), transparent 70%); }
  .spirit-fox .char-aura { background: radial-gradient(circle, rgba(150,0,255,0.6), transparent 70%); }

  /* ===== CTA BUTTON ===== */
  .cta-btn {
    position: relative;
    background: transparent;
    border: 2px solid var(--gold);
    color: var(--gold);
    font-family: 'Cinzel Decorative', cursive;
    font-size: 14px;
    letter-spacing: 4px;
    padding: 18px 50px;
    cursor: pointer;
    overflow: hidden;
    clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
    transition: all 0.3s;
    animation: fadeIn 2s ease 2.5s both;
  }
  .cta-btn::before {
    content:'';
    position:absolute;
    inset:0;
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    transform: translateX(-105%);
    transition: transform 0.4s ease;
  }
  .cta-btn:hover::before { transform: translateX(0); }
  .cta-btn:hover { color: var(--dark); }
  .cta-btn span { position:relative; z-index:1; }

  .invitation-badge {
    position: absolute;
    top: 30px;
    right: 30px;
    width: 80px;
    height: 80px;
    animation: rotateBadge 12s linear infinite;
  }

  @keyframes rotateBadge {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ===== GAME SCREEN ===== */
  #gameScreen {
    display: none;
    background: radial-gradient(ellipse at 50% 20%, #1a0520 0%, #040008 70%);
    min-height: 100vh;
    padding: 40px 20px;
  }

  .game-header {
    text-align:center;
    margin-bottom: 30px;
  }

  .game-title {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(18px, 4vw, 32px);
    color: var(--gold);
    letter-spacing: 3px;
    filter: drop-shadow(0 0 10px rgba(255,165,0,0.4));
  }

  .game-instruction {
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    letter-spacing: 2px;
    margin-top: 8px;
  }

  /* ===== STAGE ART ===== */
  .stage-art {
    width: 100%;
    max-width: 700px;
    margin: 0 auto 30px;
    position:relative;
    height: 220px;
  }

  /* ===== LYRICS PANEL ===== */
  .lyrics-container {
    max-width: 700px;
    margin: 0 auto;
    position:relative;
  }

  .lyrics-panel {
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: 4px;
    padding: 30px;
    position:relative;
    overflow: hidden;
  }
  .lyrics-panel::before {
    content:'';
    position:absolute;
    top:0; left:0; right:0;
    height:2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    animation: scanLine 3s linear infinite;
  }
  @keyframes scanLine {
    from { transform:translateX(-100%); }
    to { transform:translateX(100%); }
  }

  .lyric-line {
    font-family: 'Noto Serif KR', serif;
    font-size: clamp(16px, 3vw, 24px);
    color: rgba(255,255,255,0.3);
    line-height: 1.8;
    margin: 8px 0;
    transition: all 0.3s;
    position: relative;
  }

  .lyric-line.active {
    color: var(--gold);
    filter: drop-shadow(0 0 8px rgba(255,215,0,0.6));
    font-weight: 700;
    font-size: clamp(18px, 3.5vw, 28px);
  }

  .lyric-line.done {
    color: rgba(255,165,0,0.4);
  }

  .lyric-line .korean {
    font-size: 0.6em;
    display: block;
    opacity: 0.6;
    letter-spacing: 2px;
  }

  /* ===== MIC INPUT ===== */
  .mic-section {
    max-width: 700px;
    margin: 20px auto 0;
    text-align:center;
  }

  .mic-btn {
    width: 80px; height: 80px;
    border-radius: 50%;
    border: 3px solid var(--gold);
    background: rgba(0,0,0,0.8);
    cursor: pointer;
    position:relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 0 20px rgba(255,215,0,0.2);
  }
  .mic-btn.listening {
    border-color: var(--teal);
    box-shadow: 0 0 30px rgba(0,255,204,0.4), 0 0 60px rgba(0,255,204,0.2);
    animation: micPulse 1s ease-in-out infinite;
  }
  @keyframes micPulse {
    0%,100% { transform:scale(1); }
    50% { transform:scale(1.08); }
  }

  .mic-waves {
    position:absolute;
    inset:-20px;
    border-radius:50%;
    border: 2px solid var(--teal);
    opacity:0;
    animation: waveExpand 2s ease-out infinite;
    display:none;
  }
  .mic-btn.listening .mic-waves { display:block; }
  .mic-waves:nth-child(2) { animation-delay:0.6s; }
  .mic-waves:nth-child(3) { animation-delay:1.2s; }

  @keyframes waveExpand {
    from { transform:scale(0.8); opacity:0.6; }
    to { transform:scale(2); opacity:0; }
  }

  .volume-bar {
    display:flex;
    gap:3px;
    align-items:flex-end;
    height: 40px;
    justify-content:center;
    margin-top:15px;
  }
  .vol-stick {
    width:5px;
    background: var(--gold);
    border-radius:3px;
    min-height:3px;
    transition: height 0.05s;
    opacity:0.7;
  }

  .progress-section {
    max-width: 700px;
    margin: 20px auto 0;
  }

  .progress-label {
    font-size: 11px;
    letter-spacing: 3px;
    color: rgba(255,215,0,0.5);
    text-align:center;
    margin-bottom:8px;
  }

  .progress-bar {
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    overflow:hidden;
  }
  .progress-fill {
    height:100%;
    background: linear-gradient(90deg, var(--crimson), var(--gold));
    border-radius: 2px;
    transition: width 0.5s ease;
    width: 0%;
  }

  .demon-tokens {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
  }
  .demon-token {
    width: 30px; height: 30px;
    border-radius: 50%;
    border: 2px solid rgba(255,215,0,0.3);
    display: flex; align-items:center; justify-content:center;
    font-size: 16px;
    opacity: 0.3;
    transition: all 0.5s;
  }
  .demon-token.active {
    opacity:1;
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(255,215,0,0.5);
    animation: tokenGlow 2s ease infinite;
  }
  @keyframes tokenGlow {
    0%,100% { box-shadow:0 0 15px rgba(255,215,0,0.5); }
    50% { box-shadow:0 0 25px rgba(255,165,0,0.8); }
  }

  .hint-text {
    text-align:center;
    font-size: 11px;
    color: rgba(255,255,255,0.3);
    letter-spacing: 2px;
    margin-top: 10px;
  }

  /* ===== VICTORY SCREEN ===== */
  #victoryScreen {
    display:none;
    text-align:center;
    background: radial-gradient(ellipse at 50% 50%, #1a0a00 0%, #050000 100%);
    min-height:100vh;
    padding: 40px 20px;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }

  .victory-title {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(28px, 6vw, 60px);
    background: linear-gradient(135deg, #FFD700, #FF6B00, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: shimmer 3s ease infinite;
    background-size: 200% 100%;
    filter: drop-shadow(0 0 30px rgba(255,165,0,0.4));
  }
  @keyframes shimmer {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .invite-card {
    max-width: 500px;
    margin: 40px auto;
    background: rgba(20, 5, 0, 0.9);
    border: 1px solid rgba(255,215,0,0.4);
    padding: 40px;
    position: relative;
    clip-path: polygon(15px 0%, 100% 0%, calc(100% - 15px) 100%, 0% 100%);
  }

  .invite-card::before, .invite-card::after {
    content:'';
    position:absolute;
    width:60px; height:60px;
    border: 2px solid var(--gold);
    opacity: 0.4;
  }
  .invite-card::before { top:-1px; left:-1px; border-right:none; border-bottom:none; }
  .invite-card::after { bottom:-1px; right:-1px; border-left:none; border-top:none; }

  .invite-text {
    font-family: 'Noto Serif KR', serif;
    color: var(--ghostwhite);
    line-height: 1.9;
    font-size: clamp(13px, 2vw, 16px);
    opacity: 0.85;
  }

  .invite-highlight {
    color: var(--gold);
    font-size: 1.2em;
    font-weight: 700;
  }

  .seal {
    width: 100px; height: 100px;
    margin: 30px auto 0;
  }

  .secret-code {
    font-family: 'Cinzel Decorative', cursive;
    font-size: 18px;
    color: var(--gold);
    letter-spacing: 5px;
    margin-top: 20px;
    padding: 15px 30px;
    border: 1px solid rgba(255,215,0,0.3);
    display: inline-block;
  }

  /* ===== AUDIO VIZ ===== */
  .audio-visualizer {
    display:flex;
    gap:2px;
    justify-content:center;
    height:50px;
    align-items:flex-end;
    margin: 10px 0;
  }
  .viz-bar {
    width: 4px;
    background: linear-gradient(to top, var(--crimson), var(--gold));
    border-radius:2px;
    min-height:2px;
    transition: height 0.05s;
  }

  /* ===== FLOATING RUNES ===== */
  .rune {
    position:fixed;
    font-family: 'Noto Serif KR', serif;
    font-size: 20px;
    color: rgba(255,215,0,0.08);
    pointer-events:none;
    animation: floatRune linear infinite;
    z-index:0;
  }
  @keyframes floatRune {
    from { transform: translateY(100vh) rotate(0deg); opacity:0; }
    10% { opacity:1; }
    90% { opacity:0.5; }
    to { transform: translateY(-20vh) rotate(360deg); opacity:0; }
  }

  /* Screen transitions */
  .scene { animation: none; }
  .fade-in { animation: sceneFadeIn 0.8s ease both; }
  @keyframes sceneFadeIn {
    from { opacity:0; }
    to { opacity:1; }
  }

  /* Slash effect */
  .slash-overlay {
    position:fixed;
    inset:0;
    z-index:100;
    pointer-events:none;
    display:none;
  }
  .slash-overlay.active { display:block; }
  .slash-overlay canvas { width:100%; height:100%; }

  /* responsive */
  @media (max-width:500px) {
    .characters-row { gap:15px; }
    .char-figure { width:65px; height:105px; }
    .invite-card { padding:25px 20px; }
  }
</style>
</head>
<body>

<canvas id="particleCanvas"></canvas>

<!-- Floating runes -->
<div id="runesContainer"></div>

<!-- INTRO SCREEN -->
<div id="intro" class="scene">
  <div class="blood-moon"></div>

  <!-- Mountain silhouette -->
  <div class="mount-silhouette">
    <svg viewBox="0 0 1400 400" preserveAspectRatio="none">
      <defs>
        <linearGradient id="mtGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#1a0020"/>
          <stop offset="100%" stop-color="#000000"/>
        </linearGradient>
      </defs>
      <!-- Far mountains -->
      <polygon points="0,400 200,80 400,180 600,40 800,160 1000,60 1200,140 1400,90 1400,400" fill="rgba(30,0,40,0.8)"/>
      <!-- Near mountains -->
      <polygon points="0,400 100,200 280,280 500,120 700,260 900,100 1100,220 1300,150 1400,180 1400,400" fill="rgba(10,0,15,0.95)"/>
      <!-- Pagoda silhouette center -->
      <g transform="translate(680,80)">
        <rect x="-3" y="0" width="6" height="120" fill="#080010"/>
        <polygon points="-25,30 25,30 0,5" fill="#080010"/>
        <polygon points="-20,55 20,55 0,35" fill="#080010"/>
        <polygon points="-15,75 15,75 0,58" fill="#080010"/>
        <rect x="-12" y="75" width="24" height="40" fill="#080010"/>
      </g>
      <!-- Trees -->
      <g fill="#050008">
        <polygon points="50,400 65,320 80,400"/>
        <polygon points="55,380 65,300 75,380"/>
        <polygon points="130,400 150,300 170,400"/>
        <polygon points="135,370 150,280 165,370"/>
        <polygon points="1230,400 1250,310 1270,400"/>
        <polygon points="1235,375 1250,295 1265,375"/>
        <polygon points="1310,400 1330,320 1350,400"/>
      </g>
    </svg>
  </div>

  <!-- Invitation badge -->
  <svg class="invitation-badge" viewBox="0 0 80 80">
    <circle cx="40" cy="40" r="38" fill="none" stroke="rgba(255,215,0,0.4)" stroke-width="1"/>
    <path id="circlePath" d="M 40,40 m -30,0 a 30,30 0 1,1 60,0 a 30,30 0 1,1 -60,0" fill="none"/>
    <text font-family="'Noto Sans KR'" font-size="7" fill="rgba(255,215,0,0.6)" letter-spacing="2.2">
      <textPath href="#circlePath">‚ú¶ INVITATION ‚ú¶ Ï¥àÎåÄÏû• ‚ú¶ GOLDEN SONG ‚ú¶</textPath>
    </text>
    <text x="40" y="44" text-anchor="middle" font-size="16" fill="rgba(255,215,0,0.6)">‚öî</text>
  </svg>

  <div class="intro-content">
    <div class="eyebrow">A SPECIAL EVENT INVITATION</div>
    <h1 class="main-title" data-text="DEMON HUNTER">DEMON HUNTER</h1>
    <div class="korean-sub">ÎßàÍ∑Ä ÏÇ¨ÎÉ•Íæº ‚Äî Ìô©Í∏àÏùò ÎÖ∏Îûò</div>
    <div class="subtitle">KPOP UNIVERSE ¬∑ GOLDEN SONG ERA</div>

    <!-- Characters -->
    <div class="characters-row">

      <!-- Character 1: Hunter/Blade -->
      <div class="char-card hunter-blade" onclick="charSound('blade')" title="Press to hear ‚öîÔ∏è">
        <div class="char-aura"></div>
        <div class="char-figure">
          <svg viewBox="0 0 90 140" xmlns="http://www.w3.org/2000/svg">
            <!-- Glow aura -->
            <ellipse cx="45" cy="130" rx="25" ry="5" fill="rgba(0,200,255,0.2)"/>
            <!-- Body/Coat -->
            <rect x="28" y="55" width="34" height="60" rx="4" fill="#0a0020"/>
            <!-- Coat details -->
            <line x1="45" y1="60" x2="45" y2="115" stroke="rgba(0,200,255,0.4)" stroke-width="1"/>
            <line x1="30" y1="70" x2="60" y2="70" stroke="rgba(0,200,255,0.2)" stroke-width="0.5"/>
            <!-- Shoulders / armor -->
            <rect x="18" y="52" width="14" height="10" rx="2" fill="#1a0040"/>
            <rect x="58" y="52" width="14" height="10" rx="2" fill="#1a0040"/>
            <!-- Neck -->
            <rect x="40" y="44" width="10" height="12" rx="3" fill="#f5cba7"/>
            <!-- Head -->
            <ellipse cx="45" cy="36" rx="16" ry="18" fill="#f5cba7"/>
            <!-- Hair -->
            <ellipse cx="45" cy="22" rx="16" ry="10" fill="#1a1a1a"/>
            <ellipse cx="30" cy="30" rx="8" ry="14" fill="#1a1a1a"/>
            <!-- Eyes -->
            <ellipse cx="39" cy="34" rx="3.5" ry="4" fill="#00ccff"/>
            <ellipse cx="51" cy="34" rx="3.5" ry="4" fill="#00ccff"/>
            <ellipse cx="39" cy="34" rx="1.5" ry="2" fill="#000"/>
            <ellipse cx="51" cy="34" rx="1.5" ry="2" fill="#000"/>
            <!-- Eye glow -->
            <ellipse cx="39" cy="34" rx="3.5" ry="4" fill="none" stroke="rgba(0,200,255,0.6)" stroke-width="1"/>
            <ellipse cx="51" cy="34" rx="3.5" ry="4" fill="none" stroke="rgba(0,200,255,0.6)" stroke-width="1"/>
            <!-- Sword -->
            <line x1="65" y1="50" x2="82" y2="100" stroke="#C0C0C0" stroke-width="2.5"/>
            <line x1="65" y1="50" x2="82" y2="100" stroke="rgba(0,200,255,0.5)" stroke-width="1" filter="url(#glow)"/>
            <line x1="62" y1="62" x2="72" y2="60" stroke="#888" stroke-width="3"/>
            <!-- Robe trim -->
            <rect x="28" y="110" width="34" height="5" rx="2" fill="rgba(0,200,255,0.3)"/>
            <!-- Legs -->
            <rect x="30" y="115" width="12" height="22" rx="3" fill="#0a0030"/>
            <rect x="48" y="115" width="12" height="22" rx="3" fill="#0a0030"/>
            <!-- Boots -->
            <rect x="28" y="132" width="15" height="8" rx="2" fill="#1a0040"/>
            <rect x="47" y="132" width="15" height="8" rx="2" fill="#1a0040"/>
          </svg>
        </div>
        <div class="char-name">JIN-HO ¬∑ ÏßÑÌò∏<br><span style="font-size:9px;opacity:0.5">Blade Hunter</span></div>
      </div>

      <!-- Character 2: Golden Singer (center, taller) -->
      <div class="char-card golden-singer" style="transform:translateY(-20px)" onclick="charSound('singer')" title="Click to hear ‚ú®">
        <div class="char-aura"></div>
        <div class="char-figure" style="width:110px;height:165px;">
          <svg viewBox="0 0 110 165" xmlns="http://www.w3.org/2000/svg">
            <!-- Golden light rays -->
            <g opacity="0.3">
              <line x1="55" y1="20" x2="20" y2="0" stroke="#FFD700" stroke-width="1"/>
              <line x1="55" y1="20" x2="90" y2="0" stroke="#FFD700" stroke-width="1"/>
              <line x1="55" y1="20" x2="10" y2="30" stroke="#FFD700" stroke-width="0.5"/>
              <line x1="55" y1="20" x2="100" y2="30" stroke="#FFD700" stroke-width="0.5"/>
            </g>
            <!-- Dress / hanbok fusion -->
            <ellipse cx="55" cy="155" rx="35" ry="10" fill="rgba(255,215,0,0.1)"/>
            <!-- Skirt -->
            <path d="M 25 90 Q 10 130 20 155 Q 55 165 90 155 Q 100 130 85 90 Z" fill="#8B0000"/>
            <path d="M 25 90 Q 10 130 20 155 Q 55 165 90 155 Q 100 130 85 90 Z" fill="url(#dressGrad)"/>
            <!-- Bodice -->
            <rect x="32" y="58" width="46" height="38" rx="6" fill="#6a0000"/>
            <!-- Gold sash -->
            <rect x="28" y="80" width="54" height="8" rx="2" fill="#FFD700" opacity="0.8"/>
            <!-- Arms -->
            <ellipse cx="20" cy="72" rx="8" ry="22" fill="#f5cba7" transform="rotate(-10,20,72)"/>
            <ellipse cx="90" cy="72" rx="8" ry="22" fill="#f5cba7" transform="rotate(10,90,72)"/>
            <!-- Neck -->
            <rect x="48" y="48" width="14" height="14" rx="4" fill="#f5cba7"/>
            <!-- Head -->
            <ellipse cx="55" cy="36" rx="19" ry="21" fill="#f5cba7"/>
            <!-- Hair elaborate -->
            <ellipse cx="55" cy="18" rx="20" ry="12" fill="#1a0010"/>
            <rect x="35" y="14" width="40" height="15" rx="4" fill="#1a0010"/>
            <ellipse cx="38" cy="28" rx="7" ry="16" fill="#1a0010"/>
            <!-- Hair ornament -->
            <line x1="42" y1="10" x2="42" y2="2" stroke="#FFD700" stroke-width="1.5"/>
            <circle cx="42" cy="2" r="3" fill="#FFD700"/>
            <line x1="55" y1="8" x2="60" y2="0" stroke="#FFD700" stroke-width="1.5"/>
            <circle cx="60" cy="0" r="2" fill="#FFD700"/>
            <!-- Eyes -->
            <ellipse cx="48" cy="36" rx="4" ry="4.5" fill="#2d1010"/>
            <ellipse cx="62" cy="36" rx="4" ry="4.5" fill="#2d1010"/>
            <ellipse cx="48" cy="36" rx="2" ry="2.5" fill="rgba(255,215,0,0.8)"/>
            <ellipse cx="62" cy="36" rx="2" ry="2.5" fill="rgba(255,215,0,0.8)"/>
            <!-- Lips -->
            <path d="M 50 46 Q 55 50 60 46" stroke="#cc3333" stroke-width="2" fill="none"/>
            <!-- Gold microphone/fan -->
            <ellipse cx="12" cy="80" rx="6" ry="10" fill="#FFD700" opacity="0.7" transform="rotate(-20,12,80)"/>
            <line x1="15" y1="88" x2="20" y2="72" stroke="#FFD700" stroke-width="1.5"/>
            <!-- Glowing notes around -->
            <text x="5" y="50" font-size="10" fill="rgba(255,215,0,0.5)">‚ô™</text>
            <text x="90" y="55" font-size="12" fill="rgba(255,215,0,0.4)">‚ô¨</text>
            <text x="2" y="110" font-size="8" fill="rgba(255,215,0,0.3)">‚ô©</text>
            <defs>
              <linearGradient id="dressGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="rgba(255,100,0,0.3)"/>
                <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div class="char-name" style="font-size:13px;">SEONG-YU ¬∑ ÏÑ±Ïú†<br><span style="font-size:9px;opacity:0.5">Golden Voice</span></div>
      </div>

      <!-- Character 3: Demon Lord -->
      <div class="char-card demon-lord" onclick="charSound('demon')" title="Click to hear üëπ">
        <div class="char-aura"></div>
        <div class="char-figure">
          <svg viewBox="0 0 90 140" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="45" cy="130" rx="25" ry="5" fill="rgba(200,0,50,0.2)"/>
            <!-- Robe -->
            <path d="M 15 60 Q 10 90 15 130 Q 45 140 75 130 Q 80 90 75 60 Z" fill="#200000"/>
            <!-- Robe pattern -->
            <path d="M 15 60 Q 10 90 15 130 Q 45 140 75 130 Q 80 90 75 60 Z" fill="none" stroke="rgba(200,0,50,0.3)" stroke-width="1"/>
            <!-- Shoulders armored -->
            <ellipse cx="18" cy="60" rx="12" ry="8" fill="#3d0000" transform="rotate(-15,18,60)"/>
            <ellipse cx="72" cy="60" rx="12" ry="8" fill="#3d0000" transform="rotate(15,72,60)"/>
            <!-- Chest -->
            <rect x="28" y="60" width="34" height="40" rx="3" fill="#1a0000"/>
            <path d="M 35 65 Q 45 80 55 65" stroke="rgba(200,0,50,0.5)" stroke-width="1.5" fill="none"/>
            <!-- Neck -->
            <rect x="40" y="46" width="10" height="14" rx="3" fill="#e0b090"/>
            <!-- Head -->
            <ellipse cx="45" cy="35" rx="18" ry="20" fill="#e0b090"/>
            <!-- Pale skin tone -->
            <ellipse cx="45" cy="35" rx="18" ry="20" fill="rgba(50,0,0,0.2)"/>
            <!-- Hair wild -->
            <path d="M 27 25 Q 20 10 30 5 Q 35 15 28 20" fill="#0a0000"/>
            <path d="M 63 25 Q 70 10 60 5 Q 55 15 62 20" fill="#0a0000"/>
            <ellipse cx="45" cy="18" rx="20" ry="12" fill="#0a0000"/>
            <!-- Horns -->
            <path d="M 30 20 Q 22 5 28 0 Q 32 8 30 20" fill="#3d0000"/>
            <path d="M 60 20 Q 68 5 62 0 Q 58 8 60 20" fill="#3d0000"/>
            <!-- Eyes demonic -->
            <ellipse cx="38" cy="34" rx="5" ry="5" fill="#ff0000"/>
            <ellipse cx="52" cy="34" rx="5" ry="5" fill="#ff0000"/>
            <ellipse cx="38" cy="34" rx="2.5" ry="3" fill="#000"/>
            <ellipse cx="52" cy="34" rx="2.5" ry="3" fill="#000"/>
            <!-- Eye glow -->
            <ellipse cx="38" cy="34" rx="5" ry="5" fill="none" stroke="rgba(255,0,0,0.6)" stroke-width="1.5"/>
            <ellipse cx="52" cy="34" rx="5" ry="5" fill="none" stroke="rgba(255,0,0,0.6)" stroke-width="1.5"/>
            <!-- Snarl line -->
            <path d="M 38 44 Q 45 48 52 44" stroke="#8b0000" stroke-width="1.5" fill="none"/>
            <!-- Energy orb -->
            <circle cx="22" cy="85" r="8" fill="rgba(200,0,50,0.4)" stroke="#ff0000" stroke-width="1"/>
            <circle cx="22" cy="85" r="4" fill="rgba(255,50,50,0.6)"/>
            <!-- Legs -->
            <rect x="30" y="120" width="12" height="20" rx="2" fill="#150000"/>
            <rect x="48" y="120" width="12" height="20" rx="2" fill="#150000"/>
          </svg>
        </div>
        <div class="char-name">MA-RYONG ¬∑ ÎßàÎ£°<br><span style="font-size:9px;opacity:0.5">Demon Lord</span></div>
      </div>

      <!-- Character 4: Spirit Fox -->
      <div class="char-card spirit-fox" onclick="charSound('fox')" title="Click to hear ü¶ä">
        <div class="char-aura"></div>
        <div class="char-figure">
          <svg viewBox="0 0 90 140" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="45" cy="130" rx="25" ry="5" fill="rgba(150,0,255,0.2)"/>
            <!-- Fox tails (multiple) -->
            <path d="M 60 90 Q 80 80 85 100 Q 75 105 60 100" fill="rgba(255,150,0,0.3)" stroke="rgba(255,150,0,0.5)" stroke-width="1"/>
            <path d="M 60 95 Q 82 90 88 112 Q 76 115 62 108" fill="rgba(255,200,100,0.2)" stroke="rgba(255,200,100,0.4)" stroke-width="1"/>
            <path d="M 58 85 Q 78 70 85 88 Q 73 95 58 90" fill="rgba(255,120,0,0.3)" stroke="rgba(255,120,0,0.5)" stroke-width="1"/>
            <!-- Robe (white) -->
            <path d="M 20 60 Q 15 90 20 130 Q 45 138 70 130 Q 75 90 70 60 Z" fill="#f0e8ff"/>
            <path d="M 20 60 Q 15 90 20 130 Q 45 138 70 130 Q 75 90 70 60 Z" stroke="rgba(150,0,255,0.3)" stroke-width="1" fill="none"/>
            <!-- Sash purple -->
            <rect x="22" y="82" width="46" height="7" rx="2" fill="#6600cc" opacity="0.7"/>
            <!-- Chest -->
            <rect x="30" y="60" width="30" height="28" rx="3" fill="#e8ddf5"/>
            <!-- Neck -->
            <rect x="41" y="46" width="8" height="14" rx="3" fill="#f5cba7"/>
            <!-- Head -->
            <ellipse cx="45" cy="34" rx="17" ry="19" fill="#f5cba7"/>
            <!-- Fox ears -->
            <polygon points="28,22 22,4 36,18" fill="#ff8800"/>
            <polygon points="62,22 68,4 54,18" fill="#ff8800"/>
            <polygon points="30,20 25,8 36,18" fill="#ffb366"/>
            <polygon points="60,20 65,8 54,18" fill="#ffb366"/>
            <!-- Hair silver -->
            <ellipse cx="45" cy="20" rx="18" ry="10" fill="#d0d0d0"/>
            <ellipse cx="45" cy="16" rx="15" ry="8" fill="#e8e8e8"/>
            <!-- Eyes fox -->
            <ellipse cx="38" cy="34" rx="4" ry="4" fill="#9900ff"/>
            <ellipse cx="52" cy="34" rx="4" ry="4" fill="#9900ff"/>
            <ellipse cx="38" cy="34" rx="2" ry="3" fill="#000" transform="rotate(-10,38,34)"/>
            <ellipse cx="52" cy="34" rx="2" ry="3" fill="#000" transform="rotate(10,52,34)"/>
            <ellipse cx="38" cy="34" rx="4" ry="4" fill="none" stroke="rgba(150,0,255,0.7)" stroke-width="1"/>
            <ellipse cx="52" cy="34" rx="4" ry="4" fill="none" stroke="rgba(150,0,255,0.7)" stroke-width="1"/>
            <!-- Fox markings -->
            <path d="M 38 40 Q 45 44 52 40" stroke="#cc88ff" stroke-width="1.5" fill="none"/>
            <!-- Spirit orbs floating -->
            <circle cx="12" cy="60" r="5" fill="rgba(150,0,255,0.4)" stroke="#9900ff" stroke-width="1"/>
            <circle cx="14" cy="55" r="3" fill="rgba(200,100,255,0.5)"/>
            <!-- Legs -->
            <rect x="31" y="120" width="11" height="20" rx="2" fill="#e8ddf5"/>
            <rect x="48" y="120" width="11" height="20" rx="2" fill="#e8ddf5"/>
          </svg>
        </div>
        <div class="char-name">HA-YEON ¬∑ ÌïòÏó∞<br><span style="font-size:9px;opacity:0.5">Nine-Tail Spirit</span></div>
      </div>

    </div>

    <button class="cta-btn" onclick="startGame()">
      <span>‚ú¶ ENTER THE REALM ‚ú¶</span>
    </button>
    <div style="font-size:10px;color:rgba(255,215,0,0.3);letter-spacing:2px;margin-top:15px;">
      CLICK CHARACTERS TO HEAR THEM SING
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="scene">

  <div class="game-header">
    <div class="game-title">‚ú¶ GOLDEN SONG SING-ALONG ‚ú¶</div>
    <div class="game-instruction">SING OR HUM THE FIRST STANZA TO UNLOCK YOUR INVITATION</div>
  </div>

  <!-- Stage art -->
  <div class="stage-art">
    <canvas id="stageCanvas" width="700" height="220" style="width:100%;height:100%;"></canvas>
  </div>

  <!-- Lyrics -->
  <div class="lyrics-container">
    <div class="lyrics-panel">
      <div style="text-align:center;margin-bottom:20px;">
        <span style="font-size:10px;letter-spacing:4px;color:rgba(255,215,0,0.4);">Ìô©Í∏àÏùò ÎÖ∏Îûò ‚Äî GOLDEN SONG</span>
      </div>

      <div class="lyric-line active" id="line0">
        In the dark between the stars
        <span class="korean">Î≥ÑÎì§ ÏÇ¨Ïù¥ Ïñ¥Îë† ÏÜçÏóêÏÑú</span>
      </div>
      <div class="lyric-line" id="line1">
        Demons rise where shadows fall
        <span class="korean">Í∑∏Î¶ºÏûêÍ∞Ä ÎìúÎ¶¨Ïö∞Î©¥ ÎßàÍ∑ÄÍ∞Ä Íπ®Ïñ¥ÎÇò</span>
      </div>
      <div class="lyric-line" id="line2">
        But the golden voice calls out
        <span class="korean">Ìô©Í∏àÎπõ Î™©ÏÜåÎ¶¨Í∞Ä Ïö∏Î†§ ÌçºÏ†∏</span>
      </div>
      <div class="lyric-line" id="line3">
        Breaking every ancient wall
        <span class="korean">Ïò§ÎûòÎêú Ïû•Î≤ΩÏùÑ Î™®Îëê Î¨¥ÎÑàÎú®Î¶¨ÎÑ§</span>
      </div>

      <!-- Audio visualizer while playing -->
      <div class="audio-visualizer" id="audioViz">
        <div class="viz-bar" style="height:5px"></div>
        <div class="viz-bar" style="height:8px"></div>
        <div class="viz-bar" style="height:15px"></div>
        <div class="viz-bar" style="height:10px"></div>
        <div class="viz-bar" style="height:20px"></div>
        <div class="viz-bar" style="height:12px"></div>
        <div class="viz-bar" style="height:8px"></div>
        <div class="viz-bar" style="height:18px"></div>
        <div class="viz-bar" style="height:25px"></div>
        <div class="viz-bar" style="height:10px"></div>
        <div class="viz-bar" style="height:15px"></div>
        <div class="viz-bar" style="height:8px"></div>
        <div class="viz-bar" style="height:20px"></div>
        <div class="viz-bar" style="height:5px"></div>
        <div class="viz-bar" style="height:12px"></div>
        <div class="viz-bar" style="height:18px"></div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-label">SONG PROGRESS ¬∑ ÎÖ∏Îûò ÏßÑÌñâ</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="demon-tokens" id="demonTokens">
        <div class="demon-token" id="tok0">‚ö°</div>
        <div class="demon-token" id="tok1">üåô</div>
        <div class="demon-token" id="tok2">‚öî</div>
        <div class="demon-token" id="tok3">‚ú¶</div>
      </div>
    </div>

    <!-- Mic section -->
    <div class="mic-section">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()">
        <div class="mic-waves"></div>
        <div class="mic-waves"></div>
        <div class="mic-waves"></div>
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <rect x="11" y="3" width="10" height="18" rx="5" fill="#FFD700"/>
          <path d="M 6 16 Q 6 26 16 26 Q 26 26 26 16" stroke="#FFD700" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <line x1="16" y1="26" x2="16" y2="30" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round"/>
          <line x1="11" y1="30" x2="21" y2="30" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
      </button>

      <div class="volume-bar" id="volBar">
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
        <div class="vol-stick" style="height:4px"></div>
      </div>

      <div id="micStatus" style="font-size:11px;color:rgba(255,215,0,0.5);letter-spacing:2px;margin-top:8px;">
        TAP MIC TO BEGIN SINGING
      </div>

      <div class="hint-text">
        üéµ Tap the mic to sing along ‚Äî mic access auto-enables demo if unavailable<br>
        <span style="opacity:0.5">Or press SPACE to advance lines manually</span>
      </div>
    </div>
  </div>
</div>

<!-- VICTORY SCREEN -->
<div id="victoryScreen" class="scene" style="display:none;flex-direction:column;">

  <canvas id="fireworksCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;"></canvas>

  <div style="position:relative;z-index:1;text-align:center;padding:40px 20px;">
    <div style="font-size:12px;letter-spacing:6px;color:rgba(255,215,0,0.5);margin-bottom:20px;">
      ‚ú¶ THE SEAL IS BROKEN ‚ú¶
    </div>
    <h2 class="victory-title">YOU ARE SUMMONED</h2>
    <div style="font-family:'Noto Serif KR',serif;font-size:16px;color:rgba(255,165,0,0.7);letter-spacing:3px;margin-top:8px;">
      Ìô©Í∏àÏùò ÎÖ∏ÎûòÍ∞Ä Ïö∏Î†§ ÌçºÏ°åÏäµÎãàÎã§
    </div>

    <div class="invite-card">
      <p class="invite-text">
        Your voice has shattered the demon seal.<br><br>
        <span class="invite-highlight">JIN-HO, SEONG-YU, MA-RYONG & HA-YEON</span><br>
        hereby summon you to the<br><br>
        <span class="invite-highlight" style="font-size:1.4em;">KPOP DEMON HUNTER</span><br>
        <span style="color:rgba(255,215,0,0.6);">GOLDEN SONG ERA SHOWCASE</span><br><br>
        <span style="font-size:0.85em;color:rgba(255,255,255,0.5);">
          One night only ¬∑ When moonlight bleeds gold<br>
          Bring your voice. Leave your fear.
        </span>
      </p>

      <svg class="seal" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,215,0,0.4)" stroke-width="2"/>
        <circle cx="50" cy="50" r="38" fill="none" stroke="rgba(255,215,0,0.2)" stroke-width="1"/>
        <!-- Star of David / demon seal -->
        <polygon points="50,10 58,30 80,30 62,45 68,65 50,52 32,65 38,45 20,30 42,30" fill="rgba(255,215,0,0.15)" stroke="rgba(255,215,0,0.5)" stroke-width="1.5"/>
        <text x="50" y="54" text-anchor="middle" font-size="16" fill="rgba(255,215,0,0.6)">‚öî</text>
        <path id="sealPath" d="M 50,50 m -35,0 a 35,35 0 1,1 70,0 a 35,35 0 1,1 -70,0" fill="none"/>
        <text font-family="'Noto Serif KR'" font-size="7" fill="rgba(255,215,0,0.5)">
          <textPath href="#sealPath">ÎßàÍ∑Ä ÏÇ¨ÎÉ•Íæº ‚ú¶ DEMON HUNTER ‚ú¶ Ìô©Í∏àÏùò ÎÖ∏Îûò ‚ú¶</textPath>
        </text>
      </svg>

      <div class="secret-code" id="secretCode">KDH-GOLD-2025</div>
    </div>

    <button class="cta-btn" style="margin-top:30px;" onclick="restartGame()">
      <span>‚Ü© RETURN TO THE REALM</span>
    </button>
  </div>
</div>

<script>
// ===== AUDIO ENGINE =====
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new AudioCtx();
  return audioCtx;
}

function playNote(freq, duration, type='sine', gainVal=0.3) {
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.type = type;
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(freq * 0.95, ctx.currentTime + duration);
  gain.gain.setValueAtTime(gainVal, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
  osc.start(ctx.currentTime);
  osc.stop(ctx.currentTime + duration);
}

function playChord(notes, duration, delay=0) {
  notes.forEach((f,i) => {
    setTimeout(() => playNote(f, duration, 'sine', 0.15), delay + i*30);
  });
}

// Character sounds
const charMelodies = {
  blade: [
    { freq:392, dur:0.15 }, { freq:440, dur:0.15 }, { freq:523, dur:0.3 },
    { freq:440, dur:0.15 }, { freq:392, dur:0.2 }, { freq:329, dur:0.4 }
  ],
  singer: [
    { freq:523, dur:0.2 }, { freq:587, dur:0.2 }, { freq:659, dur:0.2 },
    { freq:698, dur:0.3 }, { freq:784, dur:0.5 }, { freq:698, dur:0.2 },
    { freq:659, dur:0.15 }, { freq:587, dur:0.4 }
  ],
  demon: [
    { freq:196, dur:0.3, type:'sawtooth' }, { freq:174, dur:0.3, type:'sawtooth' },
    { freq:155, dur:0.5, type:'sawtooth' }, { freq:130, dur:0.7, type:'sawtooth' }
  ],
  fox: [
    { freq:659, dur:0.1 }, { freq:698, dur:0.1 }, { freq:784, dur:0.1 },
    { freq:880, dur:0.15 }, { freq:988, dur:0.3 }, { freq:880, dur:0.15 },
    { freq:784, dur:0.2 }
  ]
};

function charSound(char) {
  const melody = charMelodies[char];
  let time = 0;
  melody.forEach(note => {
    setTimeout(() => {
      playNote(note.freq, note.dur, note.type || 'sine', 0.25);
    }, time * 1000);
    time += note.dur + 0.05;
  });
}

// Background music (simple pentatonic loop)
let bgMusicInterval = null;
const bgNotes = [261, 293, 329, 392, 440, 392, 329, 293];
let bgNoteIdx = 0;

function startBgMusic() {
  bgMusicInterval = setInterval(() => {
    playNote(bgNotes[bgNoteIdx % bgNotes.length], 0.4, 'sine', 0.05);
    if (bgNoteIdx % 4 === 0) {
      playNote(bgNotes[bgNoteIdx % bgNotes.length] / 2, 0.8, 'triangle', 0.04);
    }
    bgNoteIdx++;
  }, 500);
}

function stopBgMusic() {
  clearInterval(bgMusicInterval);
}

// Victory fanfare
function playVictoryFanfare() {
  const fanfare = [
    [523,0], [659,0.25], [784,0.5], [1046,0.75],
    [784,1.1], [1046,1.3], [1568,1.6]
  ];
  fanfare.forEach(([freq, delay]) => {
    setTimeout(() => playNote(freq, 0.5, 'triangle', 0.3), delay * 1000);
  });
}

// ===== PARTICLES =====
const particleCanvas = document.getElementById('particleCanvas');
const pctx = particleCanvas.getContext('2d');
let particles = [];

function resizeCanvas() {
  particleCanvas.width = window.innerWidth;
  particleCanvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function createParticle() {
  return {
    x: Math.random() * particleCanvas.width,
    y: particleCanvas.height + 10,
    vx: (Math.random()-0.5) * 0.5,
    vy: -(Math.random() * 1.5 + 0.5),
    life: 1,
    size: Math.random() * 3 + 1,
    color: Math.random() > 0.5 ? `rgba(255,215,0,` : `rgba(255,100,0,`
  };
}

function animateParticles() {
  pctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
  if (Math.random() > 0.7) particles.push(createParticle());
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 0.005;
    pctx.beginPath();
    pctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    pctx.fillStyle = p.color + p.life + ')';
    pctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

// ===== FLOATING RUNES =====
const runeChars = ['È¨º','Â¶ñ','È≠î','Èáë','Ê≠å','Âäõ','Ââë','Èú∏','Â§©','Èæç','Á•û','Ë°Ä'];
const runesContainer = document.getElementById('runesContainer');

function spawnRune() {
  const r = document.createElement('div');
  r.className = 'rune';
  r.textContent = runeChars[Math.floor(Math.random() * runeChars.length)];
  r.style.left = (Math.random() * 100) + 'vw';
  r.style.animationDuration = (15 + Math.random() * 20) + 's';
  r.style.animationDelay = (Math.random() * 5) + 's';
  r.style.fontSize = (14 + Math.random() * 20) + 'px';
  runesContainer.appendChild(r);
  setTimeout(() => r.remove(), 35000);
}
setInterval(spawnRune, 2000);
for(let i=0;i<8;i++) spawnRune();

// ===== CHERRY BLOSSOMS =====
function spawnPetal() {
  const p = document.createElement('div');
  p.className = 'cherry-blossom';
  p.textContent = ['üå∏','‚úø','‚ùÄ','‚úæ'][Math.floor(Math.random()*4)];
  p.style.left = (Math.random() * 100) + 'vw';
  p.style.animationDuration = (6 + Math.random() * 8) + 's';
  p.style.animationDelay = (Math.random() * 3) + 's';
  document.getElementById('intro').appendChild(p);
  setTimeout(() => p.remove(), 14000);
}
for(let i=0;i<15;i++) setTimeout(spawnPetal, i * 300);
setInterval(spawnPetal, 800);

// ===== STAGE CANVAS (game screen) =====
function drawStage() {
  const canvas = document.getElementById('stageCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;

  ctx.clearRect(0,0,w,h);

  // Sky gradient
  const sky = ctx.createLinearGradient(0,0,0,h);
  sky.addColorStop(0,'#0d0020');
  sky.addColorStop(1,'#1a0030');
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,w,h);

  // Moon
  ctx.save();
  ctx.shadowBlur = 40;
  ctx.shadowColor = '#ff6600';
  ctx.fillStyle = '#cc3300';
  ctx.beginPath();
  ctx.arc(w/2, 50, 40, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();

  // Stage floor with glow
  const floor = ctx.createLinearGradient(0,160,0,220);
  floor.addColorStop(0,'rgba(255,215,0,0.15)');
  floor.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = floor;
  ctx.fillRect(0,160,w,60);

  // Stage lights
  const lightColors = ['rgba(255,215,0,0.15)','rgba(255,50,50,0.12)','rgba(100,100,255,0.12)'];
  [100,350,600].forEach((x,i) => {
    const lg = ctx.createRadialGradient(x,220,0,x,220,150);
    lg.addColorStop(0,lightColors[i % lightColors.length]);
    lg.addColorStop(1,'transparent');
    ctx.fillStyle = lg;
    ctx.beginPath();
    ctx.moveTo(x,220);
    ctx.lineTo(x-80,60);
    ctx.lineTo(x+80,60);
    ctx.closePath();
    ctx.fill();
  });

  // Silhouette singer on stage
  ctx.save();
  ctx.translate(w/2, 200);
  // glow
  ctx.shadowBlur = 30;
  ctx.shadowColor = '#FFD700';
  ctx.fillStyle = 'rgba(20,5,0,0.9)';
  // body
  ctx.beginPath();
  ctx.ellipse(0,-80,12,40,0,0,Math.PI*2); ctx.fill();
  // head
  ctx.beginPath();
  ctx.arc(0,-125,18,0,Math.PI*2); ctx.fill();
  // skirt
  ctx.beginPath();
  ctx.moveTo(-12,-42);
  ctx.lineTo(-30,0);
  ctx.lineTo(30,0);
  ctx.lineTo(12,-42);
  ctx.closePath();
  ctx.fill();
  // mic arm
  ctx.shadowColor='#00FFCC';
  ctx.beginPath();
  ctx.moveTo(12,-100);
  ctx.lineTo(35,-120);
  ctx.strokeStyle='rgba(0,255,204,0.5)';
  ctx.lineWidth=2;
  ctx.stroke();
  ctx.restore();

  // Note particles on stage
  animateStageNotes(ctx, w, h);
}

let noteParticles = [];
let stageNoteT = 0;
function animateStageNotes(ctx, w, h) {
  stageNoteT += 0.02;
  if (Math.random() > 0.85) {
    noteParticles.push({
      x: w/2 + (Math.random()-0.5) * 60,
      y: 180,
      vy: -(Math.random() * 2 + 0.5),
      vx: (Math.random()-0.5) * 1.5,
      life: 1,
      char: ['‚ô™','‚ô´','‚ô¨','‚ô©'][Math.floor(Math.random()*4)]
    });
  }
  noteParticles = noteParticles.filter(p => p.life > 0);
  noteParticles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 0.015;
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.fillStyle = `hsl(${45 + Math.sin(stageNoteT)*20},100%,65%)`;
    ctx.font = `${14 + (1-p.life)*6}px serif`;
    ctx.fillText(p.char, p.x, p.y);
    ctx.restore();
  });
}

// ===== GAME LOGIC =====
let currentLine = 0;
const totalLines = 4;
let isListening = false;
let audioStream = null;
let analyserNode = null;
let micSource = null;
let silenceTimer = null;
let lineSoundTimer = null;
let lineProgress = 0; // seconds of sound detected
const SOUND_NEEDED = 2.5; // seconds per line

async function startGame() {
  document.getElementById('intro').style.display = 'none';
  const gs = document.getElementById('gameScreen');
  gs.style.display = 'flex';
  gs.classList.add('fade-in');
  currentLine = 0;
  updateLyricHighlight();
  startBgMusic();

  // Draw stage
  requestAnimationFrame(function loop() {
    drawStage();
    if (document.getElementById('gameScreen').style.display !== 'none') {
      requestAnimationFrame(loop);
    }
  });
}

function updateLyricHighlight() {
  for (let i=0; i<totalLines; i++) {
    const el = document.getElementById('line'+i);
    if (!el) continue;
    el.className = 'lyric-line';
    if (i < currentLine) el.classList.add('done');
    else if (i === currentLine) el.classList.add('active');
  }
  document.getElementById('progressFill').style.width = (currentLine/totalLines*100) + '%';

  // Token glow
  for (let i=0;i<4;i++) {
    const tok = document.getElementById('tok'+i);
    if(tok) {
      tok.className = 'demon-token' + (i < currentLine ? ' active' : '');
    }
  }

  // Play "advance" tone
  if (currentLine > 0 && currentLine <= totalLines) {
    const scaleNotes = [523, 659, 784, 1046];
    playNote(scaleNotes[currentLine-1], 0.5, 'triangle', 0.2);
    if (currentLine > 1) {
      setTimeout(() => playNote(scaleNotes[currentLine-1]*1.5, 0.3, 'sine', 0.1), 200);
    }
  }

  if (currentLine >= totalLines) {
    setTimeout(() => showVictory(), 1000);
  }
}

async function toggleMic() {
  if (isListening) {
    stopListening();
  } else {
    await startListening();
  }
}

async function startListening() {
  // Try real mic first
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    try {
      audioStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const ctx = getAudioCtx();
      micSource = ctx.createMediaStreamSource(audioStream);
      analyserNode = ctx.createAnalyser();
      analyserNode.fftSize = 256;
      micSource.connect(analyserNode);

      isListening = true;
      const btn = document.getElementById('micBtn');
      btn.classList.add('listening');
      document.getElementById('micStatus').textContent = 'LISTENING... SING! üéµ';
      document.getElementById('micStatus').style.color = 'rgba(0,255,204,0.8)';

      lineProgress = 0;
      detectVoice();
      return;
    } catch(e) {
      // Fall through to demo mode
    }
  }
  // Auto-start demo mode
  startDemoMode();
}

function startDemoMode() {
  isListening = true;
  const btn = document.getElementById('micBtn');
  btn.classList.add('listening');
  document.getElementById('micStatus').textContent = 'üéµ DEMO SINGING IN PROGRESS...';
  document.getElementById('micStatus').style.color = 'rgba(0,255,204,0.8)';
  document.getElementById('hint-text') && (document.getElementById('hint-text').style.display = 'none');
  lineProgress = 0;
  runDemoSinging();
}

function runDemoSinging() {
  if (!isListening) return;
  // Animate bars as if singing
  animateDemoBars();
  // Advance one line every ~3 seconds
  const interval = setInterval(() => {
    if (!isListening || currentLine >= totalLines) {
      clearInterval(interval);
      if (currentLine >= totalLines) setTimeout(() => showVictory(), 800);
      return;
    }
    lineProgress = 0;
    currentLine++;
    updateLyricHighlight();
    if (currentLine >= totalLines) {
      clearInterval(interval);
      setTimeout(() => showVictory(), 800);
    }
  }, 3000);
}

function animateDemoBars() {
  if (!isListening) return;
  const bars = document.querySelectorAll('.vol-stick');
  const vizBars = document.querySelectorAll('.viz-bar');
  const t = Date.now() * 0.003;
  bars.forEach((b, i) => {
    const h = 5 + Math.abs(Math.sin(t + i * 0.6) * 30) + Math.random() * 8;
    b.style.height = h + 'px';
    b.style.background = 'var(--teal)';
  });
  vizBars.forEach((b, i) => {
    const h = 5 + Math.abs(Math.sin(t * 1.5 + i * 0.4) * 40) + Math.random() * 5;
    b.style.height = h + 'px';
  });
  requestAnimationFrame(animateDemoBars);
}

function stopListening() {
  isListening = false;
  if (audioStream) {
    audioStream.getTracks().forEach(t => t.stop());
    audioStream = null;
  }
  const btn = document.getElementById('micBtn');
  btn.classList.remove('listening');
  document.getElementById('micStatus').textContent = 'TAP MIC TO BEGIN SINGING';
  document.getElementById('micStatus').style.color = 'rgba(255,215,0,0.5)';
}

let lastTimestamp = 0;
function detectVoice() {
  if (!isListening || !analyserNode) return;

  const data = new Uint8Array(analyserNode.frequencyBinCount);
  analyserNode.getByteTimeDomainData(data);

  // RMS volume
  let sum = 0;
  data.forEach(v => { const d = v/128 - 1; sum += d*d; });
  const rms = Math.sqrt(sum / data.length);

  // Update volume bars
  const bars = document.querySelectorAll('.vol-stick');
  bars.forEach((b,i) => {
    const h = Math.max(3, rms * 300 * (0.5 + Math.sin(i * 0.8 + Date.now()*0.005) * 0.5));
    b.style.height = h + 'px';
    b.style.background = rms > 0.02 ? 'var(--teal)' : 'var(--gold)';
  });

  // Update viz bars
  const vizBars = document.querySelectorAll('.viz-bar');
  analyserNode.getByteFrequencyData(data);
  vizBars.forEach((b,i) => {
    const idx = Math.floor(i * data.length / vizBars.length);
    const h = (data[idx] / 255) * 45 + 2;
    b.style.height = h + 'px';
  });

  // Detect singing
  const now = Date.now();
  if (rms > 0.02) {
    if (lastTimestamp === 0) lastTimestamp = now;
    const elapsed = (now - lastTimestamp) / 1000;
    lineProgress = elapsed;

    const pct = Math.min(1, lineProgress / SOUND_NEEDED);
    // Show per-line mini progress
    const el = document.getElementById('line'+currentLine);
    if (el) {
      el.style.textShadow = `0 0 ${pct*20}px rgba(255,215,0,${pct*0.8})`;
    }

    if (lineProgress >= SOUND_NEEDED && currentLine < totalLines) {
      lineProgress = 0;
      lastTimestamp = 0;
      currentLine++;
      updateLyricHighlight();
    }
  } else {
    lastTimestamp = 0;
  }

  if (isListening) requestAnimationFrame(detectVoice);
}

// SPACEBAR demo mode
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && document.getElementById('gameScreen').style.display !== 'none') {
    e.preventDefault();
    if (currentLine < totalLines) {
      currentLine++;
      updateLyricHighlight();
    }
  }
});

// ===== VICTORY =====
function showVictory() {
  stopListening();
  stopBgMusic();
  document.getElementById('gameScreen').style.display = 'none';
  const vs = document.getElementById('victoryScreen');
  vs.style.display = 'flex';
  vs.classList.add('fade-in');
  playVictoryFanfare();
  launchFireworks();

  // Generate unique code
  const codes = ['DEMON-SLAYER-GOLD','HWANGGEUM-VOICE','KPOP-HUNTER-VIP','GOLDEN-SONG-PASS'];
  document.getElementById('secretCode').textContent = codes[Math.floor(Math.random()*codes.length)];
}

function restartGame() {
  document.getElementById('victoryScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'none';
  document.getElementById('intro').style.display = 'flex';
  currentLine = 0;
}

// ===== FIREWORKS =====
function launchFireworks() {
  const canvas = document.getElementById('fireworksCanvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const fireworks = [];

  function Firework() {
    this.x = Math.random() * canvas.width;
    this.y = canvas.height;
    this.tx = Math.random() * canvas.width;
    this.ty = 50 + Math.random() * canvas.height * 0.5;
    this.color = `hsl(${Math.random()*60+30},100%,60%)`;
    this.particles = null;
    this.speed = 4 + Math.random() * 3;
    this.exploded = false;
    const dx = this.tx - this.x, dy = this.ty - this.y;
    const dist = Math.sqrt(dx*dx+dy*dy);
    this.vx = (dx/dist) * this.speed;
    this.vy = (dy/dist) * this.speed;
  }

  function explosion(x,y,color) {
    const pts = [];
    for(let i=0;i<60;i++) {
      const angle = (i/60) * Math.PI*2;
      const speed = 1 + Math.random() * 5;
      pts.push({ x,y, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, life:1, color });
    }
    return pts;
  }

  setInterval(() => {
    if (fireworks.length < 8) fireworks.push(new Firework());
  }, 400);

  function animateFireworks() {
    if (document.getElementById('victoryScreen').style.display === 'none') return;
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    fireworks.forEach((fw, fi) => {
      if (!fw.exploded) {
        fw.x += fw.vx;
        fw.y += fw.vy;
        ctx.beginPath();
        ctx.arc(fw.x, fw.y, 3, 0, Math.PI*2);
        ctx.fillStyle = fw.color;
        ctx.shadowColor = fw.color;
        ctx.shadowBlur = 8;
        ctx.fill();
        const dx = fw.tx - fw.x, dy = fw.ty - fw.y;
        if (Math.sqrt(dx*dx+dy*dy) < 10) {
          fw.exploded = true;
          fw.particles = explosion(fw.x, fw.y, fw.color);
        }
      } else if (fw.particles) {
        fw.particles = fw.particles.filter(p => p.life > 0);
        fw.particles.forEach(p => {
          p.x += p.vx; p.y += p.vy;
          p.vy += 0.05;
          p.life -= 0.015;
          ctx.beginPath();
          ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
          ctx.globalAlpha = p.life;
          ctx.fillStyle = p.color;
          ctx.shadowColor = p.color;
          ctx.shadowBlur = 6;
          ctx.fill();
          ctx.globalAlpha = 1;
        });
        if (fw.particles.length === 0) fireworks.splice(fi,1);
      }
    });

    requestAnimationFrame(animateFireworks);
  }
  animateFireworks();
}
</script>
</body>
</html>
